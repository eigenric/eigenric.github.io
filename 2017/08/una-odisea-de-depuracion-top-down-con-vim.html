<!DOCTYPE html>
<html lang="en">
<head>
	<!-- Basic Metas -->
	<meta charset="utf-8">
	<title>Una odisea de depuración top-down con Vim. | eigenℝic</title>
	<meta name="description" content="Jrnl es un proyecto que permite a las personas llevar un diario desde la línea de comandos. Proporciona una plataforma segura y fácil de usar para escribir y organizar tus …">
	<meta name="author" content="Ricardo Ruiz Fernández de Alba">
	<link rel="author" href=""/>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<!-- Twitter Cards and Open Graph -->
	<meta name="twitter:card" content="summary">
	<meta name="twitter:creator" content="">
	<meta name="twitter:domain" content="">
	<meta name="twitter:site" content="">
	<meta property="og:title" content="Una odisea de depuración top-down con Vim.">
	<meta property="og:description" content="Jrnl es un proyecto que permite a las personas llevar un diario desde la línea de comandos. Proporciona una plataforma segura y fácil de usar para escribir y organizar tus …">
	<meta property="og:image" content="https://eigenric.me/images/icons/avatar.png">
	<meta property="og:type" content="article">
	<meta property="og:url" content="https://eigenric.me/2017/08/una-odisea-de-depuracion-top-down-con-vim">

	<!-- Stylesheets and Web Fonts -->
	<link href="/theme/style.min.css?f46fbc66" rel="stylesheet">
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css?family=Nunito+Sans:300,700|Source+Code+Pro" rel="stylesheet" type="text/css">
	<script src="https://kit.fontawesome.com/a4053f556f.js" crossorigin="anonymous"></script>

	<!-- Favicons -->
	<link rel="apple-touch-icon" href="/images/icons/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="57x57" href="/images/icons/apple-touch-icon-57x57.png">
	<link rel="apple-touch-icon" sizes="60x60" href="/images/icons/apple-touch-icon-60x60.png">
	<link rel="apple-touch-icon" sizes="72x72" href="/images/icons/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="76x76" href="/images/icons/apple-touch-icon-76x76.png">
	<link rel="apple-touch-icon" sizes="114x114" href="/images/icons/apple-touch-icon-114x114.png">
	<link rel="apple-touch-icon" sizes="120x120" href="/images/icons/apple-touch-icon-120x120.png">
	<link rel="apple-touch-icon" sizes="144x144" href="/images/icons/apple-touch-icon-144x144.png">
	<link rel="apple-touch-icon" sizes="152x152" href="/images/icons/apple-touch-icon-152x152.png">
	<link rel="apple-touch-icon" sizes="180x180" href="/images/icons/apple-touch-icon-180x180.png">

	<link rel="icon" type="image/png" href="/images/icons/favicon-16x16.png" sizes="16x16">
	<link rel="icon" type="image/png" href="/images/icons/favicon-32x32.png" sizes="32x32">

	<meta name="theme-color" content="#1e2327">

	<meta name="msapplication-TileColor" content="#1e2327">
	<meta name="msapplication-TileImage" content="/images/icons/mstile-144x144.png">
	<meta name="msapplication-square70x70logo" content="/images/icons/mstile-small.png">
	<meta name="msapplication-square150x150logo" content="/images/icons/mstile-medium.png">
	<meta name="msapplication-wide310x150logo" content="/images/icons/mstile-wide.png">
	<meta name="msapplication-square310x310logo" content="/images/icons/mstile-large.png">

	<!--[if lt IE 9]>
	<script src="/theme/js/html5shiv.min.js"></script>
	<script src="/theme/js/respond.min.js"></script>
	<![endif]-->
</head>

<body>
	<div class="container">
		<div class="state-indicator"></div>
		<aside>
			<div id="bar-title">
				<i class="fas fa-bars btn-open"></i>
				<a href="/"><img id="avatar" alt="Site Avatar" src="/images/icons/avatar.jpg"></a>
				<div id="name"><a class="no-dec no-dec-h bold" href="/">eigenℝic</a></div>
			</div>
			<div id="bio">Maths & <br>Computer Science</div>
			<div id="bio-mob">Maths & Computer Science</div>

			<div class="zeynep">
				<ul>
					<a href="/"><img id="avatar-mob" alt="Site Avatar" src="/images/icons/avatar.jpg"></a>

						<li>
							<a class="no-dec no-dec-h bold" href="/">Home</a>
						</li>
						<li>
							<a class="no-dec no-dec-h bold" href="/blog">Blog</a>
						</li>
						<li>
							<a class="no-dec no-dec-h bold" href="/archive">Archive</a>
						</li>

					<li>
					
						<a class="social-i" target="_blank" href="http://www.github.com/eigenric"><i class="icon fa fa-github"></i></a>
					
						<a class="social-i" target="_blank" href="http://stackoverflow.com/u/8401085"><i class="icon fa fa-stack-overflow"></i></a>
					
						<a class="social-i" target="_blank" href="https://www.linkedin.com/in/ricardo-ruiz-fern%C3%A1ndez-de-alba-617253147/"><i class="icon fa fa-linkedin"></i></a>
					
						<a class="social-i" target="_blank" href="http://twitter.com/eigenric"><i class="icon fa fa-twitter"></i></a>
					
						<a class="social-i" target="_blank" href="mailto:ricardoruizfdez@gmail.com"><i class="icon fa fa-envelope"></i></a>
					
						<a class="social-i" target="_blank" href="/atom.xml"><i class="icon fa fa-rss"></i></a>
					</li>
				</ul>
			</div>

			<div id="sidebar-links">
					<a class="no-dec no-dec-h bold" href="/">Home</a>
 | 					<a class="no-dec no-dec-h bold" href="/blog">Blog</a>
 | 					<a class="no-dec no-dec-h bold" href="/archive">Archive</a>
			</div>

			<div id="social">
				<a href="http://www.github.com/eigenric" target="_blank" title="GitHub" class="icon fa fa-github"></a>
				<a href="http://stackoverflow.com/u/8401085" target="_blank" title="SO" class="icon fa fa-stack-overflow"></a>
				<a href="https://www.linkedin.com/in/ricardo-ruiz-fern%C3%A1ndez-de-alba-617253147/" target="_blank" title="Linkedin" class="icon fa fa-linkedin"></a>
				<a href="http://twitter.com/eigenric" target="_blank" title="Twitter" class="icon fa fa-twitter"></a>
				<a href="mailto:ricardoruizfdez@gmail.com" target="_blank" title="Email" class="icon fa fa-envelope"></a>
				<a href="/atom.xml" target="_blank" title="Feed" class="icon fa fa-rss"></a>
			</div>

			<hr id="sidebar-divider">
		</aside>

		<article>
	<h1 class="title"><a href="/2017/08/una-odisea-de-depuracion-top-down-con-vim" title="Permalink to Una odisea de depuración top-down con Vim.">Una odisea de depuración top-down con Vim.</a></h1>
	<time class="date" datetime="2017-08-27 00:00:00+02:00">27 ago 2017</time>
	<div class="content">
		<p><img alt="Jrnl" src="/images/jrnl.png"></p>
<p><a href="https://jrnl.sh/en/stable/" target="_blank">Jrnl</a> es un proyecto que permite a las personas llevar un diario desde la línea de comandos. Proporciona una plataforma segura y fácil de usar para escribir y organizar tus pensamientos, recuerdos y experiencias.</p>
<p>Por otro lado, <a href="https://termux.com/" target="_blank">Termux</a> es una aplicación de terminal de código abierto para dispositivos Android que permite a los usuarios ejecutar comandos y acceder a un entorno similar a una terminal de Linux en sus dispositivos móviles.</p>
<p>En este post, describiré el proceso que seguí para configurar un número de columnas fijo cuando VIM abriese ficheros de tipo JRNL y así escribir desde el teléfono gracias a termux. Y cómo durante el proceso encontré un bug en una <a href="https://github.com/raimon49/requirements.txt.vim" target="_blank">biblioteca externa que acabé corrigiendo</a></p>
<p>Yo utilizaba VIM con mi configuración antigua de <code>~/.vimrc</code>, la siguiente línea:</p>
<div class="highlight"><pre><span></span><code><span class="k">au</span> <span class="nb">BufRead</span><span class="p">,</span><span class="nb">BufNewFile</span> *.txt <span class="k">setlocal</span> <span class="nb">tw</span><span class="p">=</span><span class="m">50</span>
</code></pre></div>

<p>El problema consistía en que ahora mi <code>~/.vimrc</code> venía dado por <a href="https://vim-bootstrap.com/" target="_blank">Vim-bootstrap</a>, un generador de configuraciones de Vim.</p>
<p>Investigando, descubrí un método para ver el fichero en el que una variable en VIM fue asigada por última vez.</p>
<div class="highlight"><pre><span></span><code><span class="p">:</span><span class="k">verbose</span> <span class="k">set</span> <span class="nb">tw</span>
</code></pre></div>

<p>Así pues, en nuestro caso es el <code>vim.vim</code> del <code>ftplugin</code>. Por cierto, para cargar el <code>.vimrc</code>sin reiniciar VIM
se puede usar <code>:so ~/.vim/vimrc</code> o si se está en el propio archvo <code>:so %</code>.</p>
<p>Si no usamos el archivo <code>~/.vim/vimrc</code> de <em>Vim-Bootstrap</em>, podemos trabajar más facilmente con la depuración de VIM.</p>
<p>Cómo no era capaz de encontrar el fallo, acabé <a href="https://stackoverflow.com/questions/45905694/execute-a-line-in-vimrc-at-the-end" target="_blank">preguntando en Stackoverflow</a>. Donde comuniqué lo que había intentado y cuál era mi hipótesis.</p>
<p>Tuve la suerte de que me respondieran e intenté reproducir sus instruciones:</p>
<ul>
<li>Escribo en vimrc</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">au</span> <span class="nb">BufRead</span><span class="p">,</span> <span class="nb">BufNewFile</span> jrnl*.txt <span class="k">set</span> <span class="k">filetype</span><span class="p">=</span>jrnl
</code></pre></div>

<ul>
<li>Añado en la carpeta  <code>~/.vim/ftplugin</code></li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">set</span> <span class="nb">formatoptions</span><span class="p">+=</span><span class="k">t</span>
<span class="k">set</span> <span class="nb">textwidth</span><span class="p">=</span><span class="m">50</span>
</code></pre></div>

<p>Entonces, comenté todos los plugins y compruebo que funcionaba sin los plugins de <code>Vim-bootstrap</code>. Posteriormente, fui añadiendo uno a uno los plugins para encontrar el que generaba el problema.</p>
<p><strong>¡Capturé la biblioteca culpable!</strong> El plugin requirements.txt.vim es el encargado de sobreescribir la configuración. Cuando está activo, Vim no llama  <code>~/.vim/after/ftplugin/jrnl.vim</code></p>
<p>Inspeccionando el código de requirements.txt.vim
vemos que la <em>línea 37</em> contiene lo siguiente:</p>
<div class="highlight"><pre><span></span><code><span class="k">au</span> <span class="nb">BufNewFile</span><span class="p">,</span><span class="nb">BufRead</span> *.{txt<span class="p">,</span>ini} <span class="k">if</span>
s:isRequirementsFile<span class="p">()</span> <span class="p">|</span> <span class="k">set</span> <span class="nb">ft</span><span class="p">=</span>requirements
</code></pre></div>

<p>Es decir, que la función <code>isRequirementsFile()</code> es
llamada cada vez que se ejecuta un <code>*.txt.</code></p>
<div class="highlight"><pre><span></span><code><span class="k">function</span><span class="p">!</span> s:isRequirementsFile<span class="p">()</span>
     <span class="k">let</span> <span class="k">l</span>:filename <span class="p">=</span> expand<span class="p">(</span><span class="s2">&quot;%:p&quot;</span><span class="p">)</span>

    <span class="k">return</span> Requirements_matched_filename<span class="p">(</span><span class="k">l</span>:filename<span class="p">)</span>
<span class="k">endfunction</span>

<span class="k">function</span><span class="p">!</span> Requirements_matched_filename<span class="p">(</span>filename<span class="p">)</span>
    <span class="k">if</span> <span class="k">a</span>:filename <span class="p">=~</span># <span class="s1">&#39;\v.*require(ment)?s\.(txt|in)$&#39;</span>
        <span class="k">return</span> <span class="m">1</span>
    <span class="k">endif</span>

    <span class="k">if</span> <span class="k">a</span>:filename <span class="p">=~</span># <span class="s1">&#39;\vrequire(ment)?s/.*\.(txt|in)$&#39;</span>
        <span class="k">return</span> <span class="m">1</span>
    <span class="k">endif</span>

    <span class="k">if</span> <span class="k">a</span>:filename <span class="p">=~</span># <span class="s1">&#39;\vconstraints\.(txt|in)$&#39;</span>
        <span class="k">return</span> <span class="m">1</span>
    <span class="k">endif</span>

    <span class="k">if</span> len<span class="p">(</span><span class="k">g</span>:requirements#detect_filename_pattern<span class="p">)</span>
        \ &amp;&amp; <span class="k">a</span>:filename <span class="p">=~</span># <span class="k">g</span>:requirements#detect_filename_pattern
         <span class="k">return</span> <span class="m">1</span>
     <span class="k">endif</span>

     <span class="k">return</span> <span class="m">0</span>
<span class="k">endfunction</span>
</code></pre></div>

<p>Como vemos, esta función crea una variable <code>filename</code> que contiene la ruta completa del archivo. Devuelve el resultado de aplicarle la función <code>Requirements_matched_filename</code> a la ruta. Comprobamos que la función <code>isReq</code> devolvía 0. Por
lo tanto, el <em>bug parecía inencontrable...</em></p>
<p>Fue entonces cuando se me ocurrió la, quizás obvia pero efectiva, idea de <a href="https://vimdoc.sourceforge.net/htmldoc/syntax.html" target="_blank">leer la documentación de la sintaxis de vim</a> y nos sorprendemos al ver que a la instrucción</p>
<div class="highlight"><pre><span></span><code><span class="k">au</span> <span class="nb">BufNewFile</span><span class="p">,</span><span class="nb">BufRead</span> *.{txt<span class="p">,</span>ini} <span class="k">if</span> 
    s:isRequirementsFile<span class="p">()</span> <span class="p">|</span> <span class="k">set</span> <span class="nb">ft</span><span class="p">=</span>requirements
</code></pre></div>

<p><strong>¡le faltaba un endif!</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">au</span> <span class="nb">BufNewFile</span><span class="p">,</span><span class="nb">BufRead</span> *.{txt<span class="p">,</span>ini} <span class="k">if</span>
 s:isRequirementsFile<span class="p">()</span> <span class="p">|</span> <span class="k">set</span> <span class="nb">ft</span><span class="p">=</span>requirements <span class="p">|</span>
<span class="k">endif</span>
</code></pre></div>

<p>En efecto, la simple ausencia de un <code>endif</code> en uno de los plugins de configuración estaba sobreescribiendo nuestra orden.</p>
<p>Luego, me propuse a escribir un <a href="https://github.com/raimon49/requirements.txt.vim/pull/6" target="_blank">Pull Request</a> que fue aceptado inmediatamente.</p>
<blockquote>
<p><strong>Comentario del futuro:</strong>
   La nueva versión de JRNL abre los archivos en
   formato <code>.jrnl</code>. Ahora basta con cambiar el <code>au BufNewFil</code> a <code>*.jrnl</code> para que
   funcione.</p>
</blockquote>
	</div>

	<div id="related-articles">
		<a class="no-dec no-dec-h" href="/2017/08/tipo-de-datos-frozenset-python" id="prev-neighbour">Tipo de datos Frozenset - Python &raquo;</a>
	</div>

			<hr>
		</article>

		<footer>
			<p>© 2024 por Ricardo Ruiz con <i class='icon fa fa-heart' aria-hidden='true'></i> gracias a <a class='no-dec' target='_blank' href='http://www.getpelican.com'>Pelican</a> y <a class='no-dec' target='_blank' href='http://github.com/eigenric/pneumatic'>Pneumatic theme.</a><br><a class='no-dec' target='_blank' href='http://github.com/eigenric/eigenric.github.io'>Contenido</a> bajo licencia <a class='no-dec no-dec-h' target='_blank' href='https://creativecommons.org/licenses/by-sa/4.0/'> <i class='fab fa-creative-commons' aria-hidden='true'></i> <i class='fab fa-creative-commons-by' aria-hidden='true'></i> <i class='fab fa-creative-commons-sa' aria-hidden='true'></i></a></p>
		</footer>
	</div>

	<!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-PR6EXV7JWN"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'G-PR6EXV7JWN');
	</script>
	

	<script>
		function adjustScrollBar() {
			var state = window.getComputedStyle(
				document.querySelector(".state-indicator"), ":before"
			).getPropertyValue("z-index");

			if (state == "1" || state == "2") {
				var scrollbar_width = window.innerWidth - document.documentElement.clientWidth;
				container = document.getElementsByClassName("container")[0]
				original_width = window.getComputedStyle(container).getPropertyValue("width");

				if (scrollbar_width != "0") {
					container.style.width = parseInt(original_width, 10) - scrollbar_width + "px";
				}

				var specialMargin = document.querySelectorAll("article, footer");
				specialMargin.forEach(function(element) {
					element.style.setProperty("margin", "0px " + -scrollbar_width + "px 0px 0px");
				});
			}
//			document.documentElement.sty.setProperty('--scrollbar-width', (window.innerWidth - document.documentElement.clientWidth) + "px");
		};

		window.onload = adjustScrollBar;
		window.onchange = adjustScrollBar;
	</script>

	   <div class="zeynep-overlay"></div>

    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
	<script src="/theme/js/zeynep.min.js"></script>

    <script>
      $(function() {
        // init zeynepjs side menu
        var zeynep = $('.zeynep').zeynep({
          opened: function () {
            // log
            console.log('the side menu opened')
          },
          closed: function () {
            // log
            console.log('the side menu closed')
          }
        })

        // dynamically bind 'closing' event
        zeynep.on('closing', function () {
          // log
          console.log('this event is dynamically binded')
        })

        // handle zeynepjs overlay click
        $('.zeynep-overlay').on('click', function () {
          zeynep.close()
        })

        // open zeynepjs side menu
        $('.btn-open').on('click', function () {
          zeynep.open()
        })
      })
    </script>
</body>
</html>