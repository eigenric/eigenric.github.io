<!DOCTYPE html>
<html lang="en">
<head>
	<!-- Basic Metas -->
	<meta charset="utf-8">
	<title>Proceso de aprendizaje - Autociges | eigenℝic</title>
	<meta name="description" content="El desafío El problema inicial era claro: "No sabemos cuándo habrá cita en secretaría". Para solucionarlo, decidimos automatizar el proceso mediante un script en Selenium. El objetivo principal del proyecto …">
	<meta name="author" content="Ricardo Ruiz Fernández de Alba">
	<link rel="author" href=""/>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<!-- Twitter Cards and Open Graph -->
	<meta name="twitter:card" content="summary">
	<meta name="twitter:creator" content="">
	<meta name="twitter:domain" content="">
	<meta name="twitter:site" content="">
	<meta property="og:title" content="Proceso de aprendizaje - Autociges">
	<meta property="og:description" content="El desafío El problema inicial era claro: "No sabemos cuándo habrá cita en secretaría". Para solucionarlo, decidimos automatizar el proceso mediante un script en Selenium. El objetivo principal del proyecto …">
	<meta property="og:image" content="../../../images/icons/avatar.png">
	<meta property="og:type" content="article">
	<meta property="og:url" content="../../../blog/2017/09/proceso-de-aprendizaje-autociges">

	<!-- Stylesheets and Web Fonts -->
	<link href="/theme/style.min.css?f46fbc66" rel="stylesheet">
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css?family=Nunito+Sans:300,700|Source+Code+Pro" rel="stylesheet" type="text/css">
	<script src="https://kit.fontawesome.com/a4053f556f.js" crossorigin="anonymous"></script>

	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css" crossorigin="anonymous">

	<!-- Favicons -->
	<link rel="apple-touch-icon" href="/images/icons/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="57x57" href="/images/icons/apple-touch-icon-57x57.png">
	<link rel="apple-touch-icon" sizes="60x60" href="/images/icons/apple-touch-icon-60x60.png">
	<link rel="apple-touch-icon" sizes="72x72" href="/images/icons/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="76x76" href="/images/icons/apple-touch-icon-76x76.png">
	<link rel="apple-touch-icon" sizes="114x114" href="/images/icons/apple-touch-icon-114x114.png">
	<link rel="apple-touch-icon" sizes="120x120" href="/images/icons/apple-touch-icon-120x120.png">
	<link rel="apple-touch-icon" sizes="144x144" href="/images/icons/apple-touch-icon-144x144.png">
	<link rel="apple-touch-icon" sizes="152x152" href="/images/icons/apple-touch-icon-152x152.png">
	<link rel="apple-touch-icon" sizes="180x180" href="/images/icons/apple-touch-icon-180x180.png">

	<link rel="icon" type="image/png" href="/images/icons/favicon-16x16.png" sizes="16x16">
	<link rel="icon" type="image/png" href="/images/icons/favicon-32x32.png" sizes="32x32">

	<meta name="theme-color" content="#1e2327">

	<meta name="msapplication-TileColor" content="#1e2327">
	<meta name="msapplication-TileImage" content="/images/icons/mstile-144x144.png">
	<meta name="msapplication-square70x70logo" content="/images/icons/mstile-small.png">
	<meta name="msapplication-square150x150logo" content="/images/icons/mstile-medium.png">
	<meta name="msapplication-wide310x150logo" content="/images/icons/mstile-wide.png">
	<meta name="msapplication-square310x310logo" content="/images/icons/mstile-large.png">

	<!--[if lt IE 9]>
	<script src="/theme/js/html5shiv.min.js"></script>
	<script src="/theme/js/respond.min.js"></script>
	<![endif]-->
</head>

<body>
	<div class="container">
		<div class="state-indicator"></div>
		<aside>
			<div id="bar-title">
				<i class="fas fa-bars btn-open"></i>
				<a href="/"><img id="avatar" alt="Site Avatar" src="/images/icons/avatar.jpg"></a>
				<div id="name"><a class="no-dec no-dec-h bold" href="/">eigenℝic</a></div>
			</div>
			<div id="bio">Maths & <br>Computer Science</div>
			<div id="bio-mob">Maths & Computer Science</div>

			<div class="zeynep">
				<ul>
					<a href="/"><img id="avatar-mob" alt="Site Avatar" src="/images/icons/avatar.jpg"></a>

						<li>
							<a class="no-dec no-dec-h bold" href="/">Home</a>
						</li>
						<li>
							<a class="no-dec no-dec-h bold" href="/blog">Blog</a>
						</li>
						<li>
							<a class="no-dec no-dec-h bold" href="/archive">Archive</a>
						</li>

					<li>
					
						<a class="social-i" target="_blank" href="http://www.github.com/eigenric"><i class="icon fa fa-github"></i></a>
					
						<a class="social-i" target="_blank" href="http://stackoverflow.com/u/8401085"><i class="icon fa fa-stack-overflow"></i></a>
					
						<a class="social-i" target="_blank" href="https://www.linkedin.com/in/ricardo-ruiz-fern%C3%A1ndez-de-alba-617253147/"><i class="icon fa fa-linkedin"></i></a>
					
						<a class="social-i" target="_blank" href="http://twitter.com/eigenric"><i class="icon fa fa-twitter"></i></a>
					
						<a class="social-i" target="_blank" href="mailto:ricardoruizfdez@gmail.com"><i class="icon fa fa-envelope"></i></a>
					
						<a class="social-i" target="_blank" href="/atom.xml"><i class="icon fa fa-rss"></i></a>
					</li>
				</ul>
			</div>

			<div id="sidebar-links">
					<a class="no-dec no-dec-h bold" href="/">Home</a>
 | 					<a class="no-dec no-dec-h bold" href="/blog">Blog</a>
 | 					<a class="no-dec no-dec-h bold" href="/archive">Archive</a>
			</div>

			<div id="social">
				<a href="http://www.github.com/eigenric" target="_blank" title="GitHub" class="icon fa fa-github"></a>
				<a href="http://stackoverflow.com/u/8401085" target="_blank" title="SO" class="icon fa fa-stack-overflow"></a>
				<a href="https://www.linkedin.com/in/ricardo-ruiz-fern%C3%A1ndez-de-alba-617253147/" target="_blank" title="Linkedin" class="icon fa fa-linkedin"></a>
				<a href="http://twitter.com/eigenric" target="_blank" title="Twitter" class="icon fa fa-twitter"></a>
				<a href="mailto:ricardoruizfdez@gmail.com" target="_blank" title="Email" class="icon fa fa-envelope"></a>
				<a href="/atom.xml" target="_blank" title="Feed" class="icon fa fa-rss"></a>
			</div>

			<hr id="sidebar-divider">
		</aside>

		<article>
	<h1 class="title"><a href="/blog/2017/09/proceso-de-aprendizaje-autociges" title="Permalink to Proceso de aprendizaje - Autociges">Proceso de aprendizaje - Autociges</a></h1>
	<time class="date" datetime="2017-09-18 00:00:00+02:00">18 sep 2017</time>
	<div class="content">
		<h2>El desafío</h2>
<p>El problema inicial era claro: <strong>"No sabemos cuándo habrá cita en secretaría"</strong>.
Para solucionarlo, decidimos automatizar el proceso mediante un <strong>script en
Selenium</strong>.</p>
<p>El objetivo principal del proyecto no era crear un código abstracto o versátil, sino lograr que el mecanismo funcionara lo más rápido posible.</p>
<h3>Primeros intentos</h3>
<p>La primera versión funcional del script fue completada a las 19:15, pero los problemas surgieron al intentar ponerlo en producción.</p>
<p>Nuestra primera idea fue desplegar la aplicación en <strong>Heroku</strong>, siguiendo el desarrollo de <strong>Inemonitor</strong>. Pensábamos que, con escribir el script y usar un <strong>Scheduler</strong>, podríamos ejecutar el proceso periódicamente.</p>
<p>Sin embargo, nos dimos cuenta de que, al usar Selenium, son necesarias dos cosas:</p>
<ul>
<li>El binario del navegador utilizado (en este caso, <strong>Google Chrome</strong>).</li>
<li>El binario del <strong>webdriver</strong> (en este caso, <strong>chromedriver</strong>).</li>
</ul>
<h3>Desafíos con Heroku</h3>
<p>En un primer intento, usamos los buildpacks <code>google-chrome-heroku-buildpack</code> y <code>chromedriver-heroku-buildpack</code>, pero surgieron errores relacionados con el intérprete de Python. El problema era que Heroku no detectaba correctamente la aplicación Python, como lo había hecho en otras ocasiones.</p>
<p>Así que, añadimos el <strong>buildpack de Python-heroku</strong> y especificamos la versión de Python en el archivo <code>runtime.txt</code>: <code>python-3.6.2</code></p>
<p>Subimos nuevamente la aplicación, pero aunque esta vez Heroku detectaba Python e instalaba las dependencias del <code>requirements.txt</code>, el programa seguía sin funcionar.</p>
<h3>Decisión de cambiar a DigitalOcean</h3>
<p>Frustrados con los problemas en Heroku, decidimos cambiar de estrategia y desplegar la aplicación en <strong>DigitalOcean</strong>, gracias a unos maravillosos <strong>50€ gratis</strong> que Github nos había proporcionado.</p>
<p>Siguiendo los tutoriales de <strong>Jonathan Soma</strong> para crear y configurar un servidor en DigitalOcean:</p>
<ul>
<li><a href="http://jonathansoma.com/lede/algorithms-2017/servers/creating/">Creando un servidor</a></li>
<li><a href="http://jonathansoma.com/lede/algorithms-2017/servers/setting-up/">Configurando el servidor</a></li>
</ul>
<p>Nos encontramos con un <strong>servidor Ubuntu</strong> accesible a través de SSH, y lo mejor de todo: ¡<strong>increíblemente rápido</strong>!</p>
<h3>Subiendo el proyecto a GitHub</h3>
<p>Una vez configurado el servidor, decidimos subir el proyecto a un repositorio privado en GitHub, lo que también nos permitiría aumentar nuestras contribuciones. Para crear el repositorio desde la línea de comandos, usamos el siguiente comando:</p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-u<span class="w"> </span><span class="s1">&#39;pwaqo&#39;</span><span class="w"> </span>https://api.github.com/user/repos<span class="w"> </span>-d<span class="w"> </span><span class="s1">&#39;{&quot;name&quot;:&quot;autociges&quot;,&quot;private&quot;: &quot;true&quot;}&#39;</span>
</code></pre></div>

<p>Esto nos solicitó usuario y contraseña, ya que estábamos creando un repositorio privado.</p>
<h3>Instalación de dependencias en DigitalOcean</h3>
<p>En el servidor de DigitalOcean, seguimos los pasos para instalar Python 3.6 compilado desde el código fuente, siguiendo este tutorial:</p>
<h3>Instalar Python 3.6 en Ubuntu</h3>
<p>Una vez instalado, procedimos a instalar las dependencias del proyecto, aunque nos preocupaba que se instalaran directamente en el sistema y no en un virtualenv (pero eso lo resolveríamos más tarde).</p>
<h3>También instalamos Google Chrome y chromedriver en el servidor.</h3>
<p>Uso de pyvirtualdisplay para Selenium
Un desafío importante con Selenium es que requiere de una pantalla para funcionar, ya que controla un programa gráfico. Para solucionar esto, usamos pyvirtualdisplay, que permite crear una pantalla virtual. El código para configurar la pantalla virtual es el siguiente:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pyvirtualdisplay</span> <span class="kn">import</span> <span class="n">Display</span>

<span class="n">display</span> <span class="o">=</span> <span class="n">Display</span><span class="p">(</span><span class="n">visible</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
<span class="n">display</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</code></pre></div>

<p>Sin embargo, al utilizar una resolución de size=(800, 600), el script dio un error al intentar hacer clic en los elementos de la página. La solución fue aumentar la resolución a size=(1920, 1200) para que coincidiera con la configuración del driver de Chrome:</p>
<div class="highlight"><pre><span></span><code><span class="n">driver</span><span class="o">.</span><span class="n">set_window_size</span><span class="p">(</span><span class="mi">1920</span><span class="p">,</span> <span class="mi">1200</span><span class="p">)</span>
</code></pre></div>

<p>También agregamos la opción --no-sandbox para evitar otros posibles errores:</p>
<div class="highlight"><pre><span></span><code><span class="n">options</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">ChromeOptions</span><span class="p">()</span>
<span class="n">options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--no-sandbox&#39;</span><span class="p">)</span>
<span class="n">chrome</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">Chrome</span><span class="p">(</span><span class="s1">&#39;/usr/local/bin/chromedriver&#39;</span><span class="p">,</span> <span class="n">chrome_options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
<span class="n">Gestión</span> <span class="n">de</span> <span class="n">procesos</span> <span class="n">de</span> <span class="n">Google</span> <span class="n">Chrome</span>
<span class="n">Al</span> <span class="n">ejecutar</span> <span class="n">el</span> <span class="n">script</span><span class="p">,</span> <span class="n">nos</span> <span class="n">dimos</span> <span class="n">cuenta</span> <span class="n">de</span> <span class="n">que</span> <span class="n">los</span> <span class="n">procesos</span> <span class="n">de</span> <span class="n">Google</span> <span class="n">Chrome</span> <span class="n">no</span> <span class="n">se</span> <span class="n">cerraban</span> <span class="n">correctamente</span><span class="p">,</span> <span class="n">lo</span> <span class="n">que</span> <span class="n">generaba</span> <span class="n">procesos</span> <span class="n">huérfanos</span><span class="o">.</span> <span class="n">Para</span> <span class="n">solucionarlo</span><span class="p">,</span> <span class="n">usamos</span> <span class="n">los</span> <span class="n">siguientes</span> <span class="n">comandos</span> <span class="n">para</span> <span class="n">verificar</span> <span class="n">y</span> <span class="n">terminar</span> <span class="n">los</span> <span class="n">procesos</span> <span class="n">de</span> <span class="n">Chrome</span><span class="p">:</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>ps<span class="w"> </span>--sort<span class="w"> </span>-rss<span class="w"> </span>-eo<span class="w"> </span>rss,pid,command<span class="w"> </span><span class="p">|</span><span class="w"> </span>head
ps<span class="w"> </span>-ef<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>chrome<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-v<span class="w"> </span>grep<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print $2}&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>xargs<span class="w"> </span>-r<span class="w"> </span><span class="nb">kill</span><span class="w"> </span>-9
</code></pre></div>

<p>Además, incluimos los siguientes comandos en el script para cerrar correctamente el navegador y detener la pantalla virtual al finalizar:</p>
<div class="highlight"><pre><span></span><code><span class="n">driver</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>  <span class="c1"># Cierra todas las instancias del navegador</span>
<span class="n">display</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span> <span class="c1"># Detiene la pantalla virtual</span>
</code></pre></div>

<h2>Ejecución periódica con Cron</h2>
<p>El siguiente paso fue configurar el script para que se ejecutara periódicamente, similar al Scheduler de Heroku. Usamos el siguiente tutorial para configurar el cronjob:</p>
<h2>Configurar cronjob en DigitalOcean</h2>
<p>Para ejecutar el script cada hora, añadimos la siguiente línea en el archivo crontab con crontab -e:</p>
<div class="highlight"><pre><span></span><code><span class="mf">0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">/</span><span class="nb">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">python3</span><span class="mf">.6</span><span class="w"> </span><span class="err">~</span><span class="o">/</span><span class="n">autociges</span><span class="o">/</span><span class="n">autociges</span><span class="mf">.</span><span class="n">py</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="err">~</span><span class="o">/</span><span class="n">autociges</span><span class="o">/</span><span class="n">autociges</span><span class="mf">.</span><span class="nb">log</span>
</code></pre></div>

<p>Sin embargo, al principio nos dimos cuenta de que python3.6 no era reconocido por cron. La solución fue usar la ruta absoluta de python3.6:</p>
<p><code>/usr/local/bin/python3.6 ~/autociges/autociges.py &gt; ~/autociges/autociges.log</code></p>
<p>Solucionando problemas con el archivo citas.json
Nos encontramos con otro problema: el archivo citas.json no se estaba creando en la ubicación correcta. Para solucionarlo, utilizamos el siguiente código para obtener la ruta absoluta del archivo:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="n">current_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="vm">__file__</span><span class="p">,</span> <span class="s1">&#39;..&#39;</span><span class="p">))</span>
<span class="n">citas_config</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_dir</span><span class="p">,</span> <span class="s1">&#39;citas.json&#39;</span><span class="p">))</span>
</code></pre></div>

<h3>Configuración de variables de entorno</h3>
<p>Otro problema fue que Python 3.6 no estaba obteniendo las variables de entorno correctas al ejecutarse desde cron. Para solucionarlo, añadimos las variables de entorno en el archivo /etc/environment para que se definieran a nivel global:</p>
<div class="highlight"><pre><span></span><code><span class="nv">CIGES_USERNAME</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="nv">CIGES_PASSWORD</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
</code></pre></div>

<h3>Ejecución final</h3>
<p>Finalmente, después de todos los ajustes, logramos que el script se ejecutara correctamente a través de cron. Para comprobar su funcionamiento, configuramos el cronjob para que se ejecutara cada 2 minutos:</p>
<div class="highlight"><pre><span></span><code>*/2 <span class="gs">* *</span> * * /usr/local/bin/python3.6 /root/autociges.py &gt; /root/autociges.log
</code></pre></div>

<p>¡Y funcionó!</p>
<h3>Conclusión</h3>
<p>A pesar de los numerosos obstáculos, logramos implementar y desplegar el script Autociges de manera exitosa en DigitalOcean, resolviendo problemas relacionados con la instalación de dependencias, la ejecución de Selenium en un servidor sin interfaz gráfica y la configuración de cronjobs para la ejecución periódica del script.</p>
	</div>

	<div id="related-articles">
		<a class="no-dec no-dec-h" href="/blog/2017/11/latex-tip-raices-n-esimas" id="next-neighbour">&laquo; Latex Tip - Raíces n-ésimas</a>
		<a class="no-dec no-dec-h" href="/blog/2017/09/vim-tip-buscar-y-reemplazar" id="prev-neighbour">Vim Tip - Buscar y reemplazar &raquo;</a>
	</div>

			<hr>
		</article>

		<footer>
			<p>© 2024 por Ricardo Ruiz con <i class='icon fa fa-heart' aria-hidden='true'></i> gracias a <a class='no-dec' target='_blank' href='http://www.getpelican.com'>Pelican</a> y <a class='no-dec' target='_blank' href='http://github.com/eigenric/pneumatic'>Pneumatic theme.</a><br><a class='no-dec' target='_blank' href='http://github.com/eigenric/eigenric.github.io'>Contenido</a> bajo licencia <a class='no-dec no-dec-h' target='_blank' href='https://creativecommons.org/licenses/by-sa/4.0/'> <i class='fab fa-creative-commons' aria-hidden='true'></i> <i class='fab fa-creative-commons-by' aria-hidden='true'></i> <i class='fab fa-creative-commons-sa' aria-hidden='true'></i></a></p>
		</footer>
	</div>

	<!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-PR6EXV7JWN"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'G-PR6EXV7JWN');
	</script>
	

	<script>
		function adjustScrollBar() {
			var state = window.getComputedStyle(
				document.querySelector(".state-indicator"), ":before"
			).getPropertyValue("z-index");

			if (state == "1" || state == "2") {
				var scrollbar_width = window.innerWidth - document.documentElement.clientWidth;
				container = document.getElementsByClassName("container")[0]
				original_width = window.getComputedStyle(container).getPropertyValue("width");

				if (scrollbar_width != "0") {
					container.style.width = parseInt(original_width, 10) - scrollbar_width + "px";
				}

				var specialMargin = document.querySelectorAll("article, footer");
				specialMargin.forEach(function(element) {
					element.style.setProperty("margin", "0px " + -scrollbar_width + "px 0px 0px");
				});
			}
//			document.documentElement.sty.setProperty('--scrollbar-width', (window.innerWidth - document.documentElement.clientWidth) + "px");
		};

		window.onload = adjustScrollBar;
		window.onchange = adjustScrollBar;
	</script>

	   <div class="zeynep-overlay"></div>

    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
	<script src="/theme/js/zeynep.min.js"></script>

    <script>
      $(function() {
        // init zeynepjs side menu
        var zeynep = $('.zeynep').zeynep({
          opened: function () {
            // log
            console.log('the side menu opened')
          },
          closed: function () {
            // log
            console.log('the side menu closed')
          }
        })

        // dynamically bind 'closing' event
        zeynep.on('closing', function () {
          // log
          console.log('this event is dynamically binded')
        })

        // handle zeynepjs overlay click
        $('.zeynep-overlay').on('click', function () {
          zeynep.close()
        })

        // open zeynepjs side menu
        $('.btn-open').on('click', function () {
          zeynep.open()
        })
      })
    </script>
</body>
</html>