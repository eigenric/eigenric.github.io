<!DOCTYPE html>
<html lang="en">
<head>
	<!-- Basic Metas -->
	<meta charset="utf-8">
	<title>Autociges | eigenℝic</title>
	<meta name="description" content="Proceso de aprendizaje durante el desarollo de Autociges: Ante el problema: "No sabemos cuándo habrá cita para presentar la matrícula de honor", nos propusimos escribir un script Selenium para automatizar …">
	<meta name="author" content="Ricardo Ruiz Fernández de Alba">
	<link rel="author" href=""/>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<!-- Twitter Cards and Open Graph -->
	<meta name="twitter:card" content="summary">
	<meta name="twitter:creator" content="">
	<meta name="twitter:domain" content="">
	<meta name="twitter:site" content="">
	<meta property="og:title" content="Autociges">
	<meta property="og:description" content="Proceso de aprendizaje durante el desarollo de Autociges: Ante el problema: "No sabemos cuándo habrá cita para presentar la matrícula de honor", nos propusimos escribir un script Selenium para automatizar …">
	<meta property="og:image" content="https://eigenric.me/images/icons/avatar.png">
	<meta property="og:type" content="article">
	<meta property="og:url" content="https://eigenric.me//blog/2017/09/autociges">

	<!-- Stylesheets and Web Fonts -->
	<link href="/theme/style.min.css?f46fbc66" rel="stylesheet">
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css?family=Nunito+Sans:300,700|Source+Code+Pro" rel="stylesheet" type="text/css">
	<script src="https://kit.fontawesome.com/a4053f556f.js" crossorigin="anonymous"></script>

	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css" crossorigin="anonymous">

	<!-- Favicons -->
	<link rel="apple-touch-icon" href="/images/icons/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="57x57" href="/images/icons/apple-touch-icon-57x57.png">
	<link rel="apple-touch-icon" sizes="60x60" href="/images/icons/apple-touch-icon-60x60.png">
	<link rel="apple-touch-icon" sizes="72x72" href="/images/icons/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="76x76" href="/images/icons/apple-touch-icon-76x76.png">
	<link rel="apple-touch-icon" sizes="114x114" href="/images/icons/apple-touch-icon-114x114.png">
	<link rel="apple-touch-icon" sizes="120x120" href="/images/icons/apple-touch-icon-120x120.png">
	<link rel="apple-touch-icon" sizes="144x144" href="/images/icons/apple-touch-icon-144x144.png">
	<link rel="apple-touch-icon" sizes="152x152" href="/images/icons/apple-touch-icon-152x152.png">
	<link rel="apple-touch-icon" sizes="180x180" href="/images/icons/apple-touch-icon-180x180.png">

	<link rel="icon" type="image/png" href="/images/icons/favicon-16x16.png" sizes="16x16">
	<link rel="icon" type="image/png" href="/images/icons/favicon-32x32.png" sizes="32x32">

	<meta name="theme-color" content="#1e2327">

	<meta name="msapplication-TileColor" content="#1e2327">
	<meta name="msapplication-TileImage" content="/images/icons/mstile-144x144.png">
	<meta name="msapplication-square70x70logo" content="/images/icons/mstile-small.png">
	<meta name="msapplication-square150x150logo" content="/images/icons/mstile-medium.png">
	<meta name="msapplication-wide310x150logo" content="/images/icons/mstile-wide.png">
	<meta name="msapplication-square310x310logo" content="/images/icons/mstile-large.png">

	<!--[if lt IE 9]>
	<script src="/theme/js/html5shiv.min.js"></script>
	<script src="/theme/js/respond.min.js"></script>
	<![endif]-->
</head>

<body>
	<div class="container">
		<div class="state-indicator"></div>
		<aside>
			<div id="bar-title">
				<i class="fas fa-bars btn-open"></i>
				<a href="/"><img id="avatar" alt="Site Avatar" src="/images/icons/avatar.jpg"></a>
				<div id="name"><a class="no-dec no-dec-h bold" href="/">eigenℝic</a></div>
			</div>
			<div id="bio">Maths & <br>Computer Science</div>
			<div id="bio-mob">Maths & Computer Science</div>

			<div class="zeynep">
				<ul>
					<a href="/"><img id="avatar-mob" alt="Site Avatar" src="/images/icons/avatar.jpg"></a>

						<li>
							<a class="no-dec no-dec-h bold" href="/">Home</a>
						</li>
						<li>
							<a class="no-dec no-dec-h bold" href="/blog">Blog</a>
						</li>
						<li>
							<a class="no-dec no-dec-h bold" href="/archive">Archive</a>
						</li>

					<li>
					
						<a class="social-i" target="_blank" href="http://www.github.com/eigenric"><i class="icon fa fa-github"></i></a>
					
						<a class="social-i" target="_blank" href="http://stackoverflow.com/u/8401085"><i class="icon fa fa-stack-overflow"></i></a>
					
						<a class="social-i" target="_blank" href="https://www.linkedin.com/in/ricardo-ruiz-fern%C3%A1ndez-de-alba-617253147/"><i class="icon fa fa-linkedin"></i></a>
					
						<a class="social-i" target="_blank" href="http://twitter.com/eigenric"><i class="icon fa fa-twitter"></i></a>
					
						<a class="social-i" target="_blank" href="mailto:ricardoruizfdez@gmail.com"><i class="icon fa fa-envelope"></i></a>
					
						<a class="social-i" target="_blank" href="/atom.xml"><i class="icon fa fa-rss"></i></a>
					</li>
				</ul>
			</div>

			<div id="sidebar-links">
					<a class="no-dec no-dec-h bold" href="/">Home</a>
 | 					<a class="no-dec no-dec-h bold" href="/blog">Blog</a>
 | 					<a class="no-dec no-dec-h bold" href="/archive">Archive</a>
			</div>

			<div id="social">
				<a href="http://www.github.com/eigenric" target="_blank" title="GitHub" class="icon fa fa-github"></a>
				<a href="http://stackoverflow.com/u/8401085" target="_blank" title="SO" class="icon fa fa-stack-overflow"></a>
				<a href="https://www.linkedin.com/in/ricardo-ruiz-fern%C3%A1ndez-de-alba-617253147/" target="_blank" title="Linkedin" class="icon fa fa-linkedin"></a>
				<a href="http://twitter.com/eigenric" target="_blank" title="Twitter" class="icon fa fa-twitter"></a>
				<a href="mailto:ricardoruizfdez@gmail.com" target="_blank" title="Email" class="icon fa fa-envelope"></a>
				<a href="/atom.xml" target="_blank" title="Feed" class="icon fa fa-rss"></a>
			</div>

			<hr id="sidebar-divider">
		</aside>

		<article>
	<h1 class="title"><a href="//blog/2017/09/autociges" title="Permalink to Autociges">Autociges</a></h1>
	<time class="date" datetime="2017-09-18 00:00:00+02:00">18 sep 2017</time>
	<div class="content">
		<p>Proceso de aprendizaje durante el desarollo de Autociges:</p>
<p>Ante el problema: "No sabemos cuándo habrá cita para presentar la matrícula de
honor", nos propusimos escribir un script Selenium para automatizar este
mecanismo.</p>
<p>La prioridad durante este proyecto no estaba en la abstracción y versatilidad
del código sino en el funcionamiento lo más inmediato posible.</p>
<p>Inspeccionando el log, vemos que la primera versión en funcionamiento es a las
19:15.  Sin embargo, los problemas vinieron al tratar de poner en marcha en
producción.</p>
<p>Copiando nuestro desarrollo de inemonitor, pensamos en desplegar la aplicación
en Heroku.  Simplemente necesitaríamos escribir el script y mediante un
Scheduler, se llamaría periódicamente.</p>
<p>Sin embargo, recordamos que al utilizar selenium son necesarias dos cosas:</p>
<ul>
<li>El binario del navegador utilizado (en este caso Google Chrome) - El binario
del webdriver (en este caso chromedriver).</li>
</ul>
<p>Primero utilizamos los buildpacks - google-chrome-heroku-buildpack -
chromedriver-heroku-buildpack</p>
<p>Sin embargo, daba ciertos errores con el intérprete de Python. Ello era porque
no estaba detectando la aplicación Python como otras veces lo había hecho.</p>
<p>Así pues, añadimos el buildpack de Python-heroku y especificamos el archivo
runtime.txt</p>
<p>python-3.6.2</p>
<p>Así pues, volvimos a subir la aplicación. Si bien esta vez sí detectaba Python,
e instalaba los requirements.txt, el programa seguía sin funcionar.</p>
<p>Fue así como le dimos por culo a Heroku, y nos dispusimos gracias a una serie
maravillosa de tutoriales a desplegar en Digital Ocean (recordando que Github
nos había regalado unos maravillosos 50€)</p>
<ul>
<li>http://jonathansoma.com/lede/algorithms-2017/servers/creating/ -
http://jonathansoma.com/lede/algorithms-2017/servers/setting-up/</li>
</ul>
<p>Véase los jrnl dev: Instalar y configurar servidor en DigitalOcean.</p>
<p>Así pues, mediante ssh nos encontramos con un maravilloso servidor Ubuntu, listo
para usar desde nuestro ordenador, y lo mejor:</p>
<p>Asquerosamente rápido</p>
<p>Con una velocidad de descarga de 30Mb/s, nos asombraba manejar una línea de
comandos remota tan asquerosamente rápido.</p>
<p>Una vez en el servidor, cambiamos a local para subir a Github privado el
Proyecto autociges (y así aumentar nuestro número de contribuciones además de no
perder la racha).</p>
<p>Para crear el repositorio sin movernos de la línea de comandos, usamos la orden:</p>
<p>curl -u 'pwaqo' https://api.github.com/user/repos -d '{"name":"autociges",
"private": "true"}'</p>
<p>La cual nos pidió usuario y contraseña al tratarse de la creación de un
repositorio y privado.</p>
<p>Así pues, posteriormente desde el servidor instalamos Python3.6 compilándolo
desde el código fuente. (Esta vez no faltó la librería sqlite3, ya que en el
tutorial que seguimos, todas las dependencias eran instaladas anteriormente)</p>
<p>https://tecadmin.net/install-python-3-6-ubuntu-linuxmint/</p>
<p>Véase otro jrnl dev Python3.6 desde código fuente.</p>
<p>Una vez instalado, nos dedicamos a instalar todas las dependencias del proyecto.
(Nos preocupa un poco el hecho de haberlas instalado en el sistema y no en
ningún virtualenv) (Pero eso lo discutiremos más tarde).</p>
<p>Instalamos por supuesto, el propio Google chrome y chromedriver.</p>
<p>El en tutorial de jonathansoma, se nos informaba que Selenium requiere de una
pantalla para funcionar (ya que está controlando un programa gráfico). Por ello,
se utiliza pyvirtualdisplay</p>
<p>El funcionamiento es bastante sencillo</p>
<p>from pyvirtualdisplay import Display</p>
<p>display = Display(visible=0, size=(x, y)) display.start()</p>
<p>Sin embargo, con size=(800,600), el programa daba error de Click.</p>
<p>Tras una búsqueda, encontramos esto</p>
<p>driver.set_window_size(1920, 1200)</p>
<p>Así pues, cambiamos la size de la pantalla a (1920, 1200) justo como el driver.</p>
<p>Además, añadimos la opción ('--no-sandbox') mediante</p>
<p>options = webdriver.ChromeOptions() options.add_argument('--no-sandbox') chrome
= webdriver.Chrome('/usr/local/bin/chromedriver', chrome_options='--no-sandbox')</p>
<p>Ejecutando el script y obteniendo errores nos dimos cuenta de que los procesos
que mantenían Google Chrome vivo seguían abiertos.</p>
<p>Este comando nos devuelve los procesos más usados</p>
<p>ps --sort -rss -eo rss,pid,command | head</p>
<p>Y este comando mata todos los chrome</p>
<p>ps -ef | grep chrome | grep -v grep | awk '{print $2}' | xargs -r kill -9</p>
<p>Así pues, cambiamos lo siguiente:</p>
<p>driver.quit() # Cierra todas las instancias del navegador display.stop() #
Termina con la pantall virtual</p>
<p>Este último no se encontraba en el tutorial de jonathansoma</p>
<p>Finalmente el script funcionaba correctamente cuando era ejecutado mediante:</p>
<p>python3.6 autociges.py</p>
<p>Sin embargo, nos metimos en el arduo trabajo de crear nuestro cronjob para que
fuera ejecutado periódicamente (al estilo del Scheduler de Heroku).</p>
<p>Usamos el tutorial</p>
<p>http://jonathansoma.com/lede/algorithms-2017/servers/cron/</p>
<p>Pero como queriamos que fuera cada hora, nos encontramos con esto:</p>
<p>https://crontab.guru/every-1-hour</p>
<p>Así pues, mediante la orden crontab -e, se añaden los trabajos. Escribimos lo
siguiente:</p>
<p>0 * * * * python3.6 ~/autociges/autociges.py &gt; ~/autociges/autociges.log</p>
<p>Con la intención de que el resultado del programa fuera redirigido a un archivo
log.</p>
<p>Sin embargo tras un rato, nos dimos cuenta de que python3.6 no era reconocido
por cron. Era necesario escribir la ruta absoluta:</p>
<p>/usr/local/bin/python3.6 ~/autociges/autociges.py &gt; ~/autociges/autociges.log</p>
<p>Sin embargo nos encontramos con el siguiente error:</p>
<p>a) citas.json no estaba siendo creado en el lugar correcto. Así pues nos
propusimos abrir el archivo citas.json mediante una abspath. Para ello:</p>
<p>import os from pathlib import Path</p>
<p>current_dir = os.path.abspath(os.path.join(<strong>file</strong>, '..')) citas_config =
Path(os.path.join(current_dir, 'citas.json'))</p>
<p>Si bien solucionamos ese problema, nos encontramos que python3.6 no estaba
obteniendo las correctas variables de entorno. Tras un rato de investigación, lo
mejor fue colocar las siguientes variables en el archivo /etc/environment (las
cuales se declaran a nivel global del sistema)</p>
<p>CIGES_USERNAME="" CIGES_PASSWORD=""</p>
<p>Finalmente, el script era ejecutado por cron. Para comprobarlo cambiamos la
orden para que fuera ejecutado cada dos minutos</p>
<p>*/2 * * * * /usr/local/bin/python3.6
/root/autociges.py &gt; /root/autociges.log</p>
<p>Funcionaba!</p>
	</div>


			<hr>
		</article>

		<footer>
			<p>© 2024 por Ricardo Ruiz con <i class='icon fa fa-heart' aria-hidden='true'></i> gracias a <a class='no-dec' target='_blank' href='http://www.getpelican.com'>Pelican</a> y <a class='no-dec' target='_blank' href='http://github.com/eigenric/pneumatic'>Pneumatic theme.</a><br><a class='no-dec' target='_blank' href='http://github.com/eigenric/eigenric.github.io'>Contenido</a> bajo licencia <a class='no-dec no-dec-h' target='_blank' href='https://creativecommons.org/licenses/by-sa/4.0/'> <i class='fab fa-creative-commons' aria-hidden='true'></i> <i class='fab fa-creative-commons-by' aria-hidden='true'></i> <i class='fab fa-creative-commons-sa' aria-hidden='true'></i></a></p>
		</footer>
	</div>

	<!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-PR6EXV7JWN"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'G-PR6EXV7JWN');
	</script>
	

	<script>
		function adjustScrollBar() {
			var state = window.getComputedStyle(
				document.querySelector(".state-indicator"), ":before"
			).getPropertyValue("z-index");

			if (state == "1" || state == "2") {
				var scrollbar_width = window.innerWidth - document.documentElement.clientWidth;
				container = document.getElementsByClassName("container")[0]
				original_width = window.getComputedStyle(container).getPropertyValue("width");

				if (scrollbar_width != "0") {
					container.style.width = parseInt(original_width, 10) - scrollbar_width + "px";
				}

				var specialMargin = document.querySelectorAll("article, footer");
				specialMargin.forEach(function(element) {
					element.style.setProperty("margin", "0px " + -scrollbar_width + "px 0px 0px");
				});
			}
//			document.documentElement.sty.setProperty('--scrollbar-width', (window.innerWidth - document.documentElement.clientWidth) + "px");
		};

		window.onload = adjustScrollBar;
		window.onchange = adjustScrollBar;
	</script>

	   <div class="zeynep-overlay"></div>

    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
	<script src="/theme/js/zeynep.min.js"></script>

    <script>
      $(function() {
        // init zeynepjs side menu
        var zeynep = $('.zeynep').zeynep({
          opened: function () {
            // log
            console.log('the side menu opened')
          },
          closed: function () {
            // log
            console.log('the side menu closed')
          }
        })

        // dynamically bind 'closing' event
        zeynep.on('closing', function () {
          // log
          console.log('this event is dynamically binded')
        })

        // handle zeynepjs overlay click
        $('.zeynep-overlay').on('click', function () {
          zeynep.close()
        })

        // open zeynepjs side menu
        $('.btn-open').on('click', function () {
          zeynep.open()
        })
      })
    </script>
</body>
</html>